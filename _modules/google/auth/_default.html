
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>google.auth._default &#8212; google-auth 1.30.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for google.auth._default</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2015 Google Inc.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Application default credentials.</span>

<span class="sd">Implements application default credentials and project ID detection.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">google.auth</span> <span class="kn">import</span> <span class="n">environment_vars</span>
<span class="kn">from</span> <span class="nn">google.auth</span> <span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">import</span> <span class="nn">google.auth.transport._http_client</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Valid types accepted for file-based credentials.</span>
<span class="n">_AUTHORIZED_USER_TYPE</span> <span class="o">=</span> <span class="s2">&quot;authorized_user&quot;</span>
<span class="n">_SERVICE_ACCOUNT_TYPE</span> <span class="o">=</span> <span class="s2">&quot;service_account&quot;</span>
<span class="n">_EXTERNAL_ACCOUNT_TYPE</span> <span class="o">=</span> <span class="s2">&quot;external_account&quot;</span>
<span class="n">_VALID_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="n">_AUTHORIZED_USER_TYPE</span><span class="p">,</span> <span class="n">_SERVICE_ACCOUNT_TYPE</span><span class="p">,</span> <span class="n">_EXTERNAL_ACCOUNT_TYPE</span><span class="p">)</span>

<span class="c1"># Help message when no credentials can be found.</span>
<span class="n">_HELP_MESSAGE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Could not automatically determine credentials. Please set </span><span class="si">{env}</span><span class="s2"> or </span><span class="se">\</span>
<span class="s2">explicitly create credentials and re-run the application. For more </span><span class="se">\</span>
<span class="s2">information, please see </span><span class="se">\</span>
<span class="s2">https://cloud.google.com/docs/authentication/getting-started</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">env</span><span class="o">=</span><span class="n">environment_vars</span><span class="o">.</span><span class="n">CREDENTIALS</span>
<span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="c1"># Warning when using Cloud SDK user credentials</span>
<span class="n">_CLOUD_SDK_CREDENTIALS_WARNING</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Your application has authenticated using end user credentials from Google </span><span class="se">\</span>
<span class="s2">Cloud SDK without a quota project. You might receive a &quot;quota exceeded&quot; </span><span class="se">\</span>
<span class="s2">or &quot;API not enabled&quot; error. We recommend you rerun </span><span class="se">\</span>
<span class="s2">`gcloud auth application-default login` and make sure a quota project is </span><span class="se">\</span>
<span class="s2">added. Or you can use service accounts instead. For more information </span><span class="se">\</span>
<span class="s2">about service accounts, see https://cloud.google.com/docs/authentication/&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_warn_about_problematic_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines if the credentials are problematic.</span>

<span class="sd">    Credentials from the Cloud SDK that are associated with Cloud SDK&#39;s project</span>
<span class="sd">    are problematic because they may not have APIs enabled and have limited</span>
<span class="sd">    quota. If this is the case, warn about it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">google.auth</span> <span class="kn">import</span> <span class="n">_cloud_sdk</span>

    <span class="k">if</span> <span class="n">credentials</span><span class="o">.</span><span class="n">client_id</span> <span class="o">==</span> <span class="n">_cloud_sdk</span><span class="o">.</span><span class="n">CLOUD_SDK_CLIENT_ID</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">_CLOUD_SDK_CREDENTIALS_WARNING</span><span class="p">)</span>


<div class="viewcode-block" id="load_credentials_from_file"><a class="viewcode-back" href="../../../reference/google.auth.html#google.auth.load_credentials_from_file">[docs]</a><span class="k">def</span> <span class="nf">load_credentials_from_file</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_scopes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quota_project_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads Google credentials from a file.</span>

<span class="sd">    The credentials file must be a service account key, stored authorized</span>
<span class="sd">    user credentials or external account credentials.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (str): The full path to the credentials file.</span>
<span class="sd">        scopes (Optional[Sequence[str]]): The list of scopes for the credentials. If</span>
<span class="sd">            specified, the credentials will automatically be scoped if</span>
<span class="sd">            necessary</span>
<span class="sd">        default_scopes (Optional[Sequence[str]]): Default scopes passed by a</span>
<span class="sd">            Google client library. Use &#39;scopes&#39; for user-defined scopes.</span>
<span class="sd">        quota_project_id (Optional[str]):  The project ID used for</span>
<span class="sd">            quota and billing.</span>
<span class="sd">        request (Optional[google.auth.transport.Request]): An object used to make</span>
<span class="sd">            HTTP requests. This is used to determine the associated project ID</span>
<span class="sd">            for a workload identity pool resource (external account credentials).</span>
<span class="sd">            If not specified, then it will use a</span>
<span class="sd">            google.auth.transport.requests.Request client to make requests.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[google.auth.credentials.Credentials, Optional[str]]: Loaded</span>
<span class="sd">            credentials and the project ID. Authorized user credentials do not</span>
<span class="sd">            have the project ID information. External account credentials project</span>
<span class="sd">            IDs may not always be determined.</span>

<span class="sd">    Raises:</span>
<span class="sd">        google.auth.exceptions.DefaultCredentialsError: if the file is in the</span>
<span class="sd">            wrong format or is missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DefaultCredentialsError</span><span class="p">(</span>
            <span class="s2">&quot;File </span><span class="si">{}</span><span class="s2"> was not found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_obj</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">caught_exc</span><span class="p">:</span>
            <span class="n">new_exc</span> <span class="o">=</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DefaultCredentialsError</span><span class="p">(</span>
                <span class="s2">&quot;File </span><span class="si">{}</span><span class="s2"> is not a valid json file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">caught_exc</span>
            <span class="p">)</span>
            <span class="n">six</span><span class="o">.</span><span class="n">raise_from</span><span class="p">(</span><span class="n">new_exc</span><span class="p">,</span> <span class="n">caught_exc</span><span class="p">)</span>

    <span class="c1"># The type key should indicate that the file is either a service account</span>
    <span class="c1"># credentials file or an authorized user credentials file.</span>
    <span class="n">credential_type</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">credential_type</span> <span class="o">==</span> <span class="n">_AUTHORIZED_USER_TYPE</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">google.oauth2</span> <span class="kn">import</span> <span class="n">credentials</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">credentials</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">Credentials</span><span class="o">.</span><span class="n">from_authorized_user_info</span><span class="p">(</span>
                <span class="n">info</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="n">scopes</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">caught_exc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to load authorized user credentials from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">new_exc</span> <span class="o">=</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DefaultCredentialsError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">caught_exc</span><span class="p">)</span>
            <span class="n">six</span><span class="o">.</span><span class="n">raise_from</span><span class="p">(</span><span class="n">new_exc</span><span class="p">,</span> <span class="n">caught_exc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">quota_project_id</span><span class="p">:</span>
            <span class="n">credentials</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">with_quota_project</span><span class="p">(</span><span class="n">quota_project_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">credentials</span><span class="o">.</span><span class="n">quota_project_id</span><span class="p">:</span>
            <span class="n">_warn_about_problematic_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">credentials</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">elif</span> <span class="n">credential_type</span> <span class="o">==</span> <span class="n">_SERVICE_ACCOUNT_TYPE</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">google.oauth2</span> <span class="kn">import</span> <span class="n">service_account</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">credentials</span> <span class="o">=</span> <span class="n">service_account</span><span class="o">.</span><span class="n">Credentials</span><span class="o">.</span><span class="n">from_service_account_info</span><span class="p">(</span>
                <span class="n">info</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="n">scopes</span><span class="p">,</span> <span class="n">default_scopes</span><span class="o">=</span><span class="n">default_scopes</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">caught_exc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to load service account credentials from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">new_exc</span> <span class="o">=</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DefaultCredentialsError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">caught_exc</span><span class="p">)</span>
            <span class="n">six</span><span class="o">.</span><span class="n">raise_from</span><span class="p">(</span><span class="n">new_exc</span><span class="p">,</span> <span class="n">caught_exc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">quota_project_id</span><span class="p">:</span>
            <span class="n">credentials</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">with_quota_project</span><span class="p">(</span><span class="n">quota_project_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project_id&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">credential_type</span> <span class="o">==</span> <span class="n">_EXTERNAL_ACCOUNT_TYPE</span><span class="p">:</span>
        <span class="n">credentials</span><span class="p">,</span> <span class="n">project_id</span> <span class="o">=</span> <span class="n">_get_external_account_credentials</span><span class="p">(</span>
            <span class="n">info</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">,</span>
            <span class="n">scopes</span><span class="o">=</span><span class="n">scopes</span><span class="p">,</span>
            <span class="n">default_scopes</span><span class="o">=</span><span class="n">default_scopes</span><span class="p">,</span>
            <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">quota_project_id</span><span class="p">:</span>
            <span class="n">credentials</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">with_quota_project</span><span class="p">(</span><span class="n">quota_project_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">project_id</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DefaultCredentialsError</span><span class="p">(</span>
            <span class="s2">&quot;The file </span><span class="si">{file}</span><span class="s2"> does not have a valid type. &quot;</span>
            <span class="s2">&quot;Type is </span><span class="si">{type}</span><span class="s2">, expected one of </span><span class="si">{valid_types}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">file</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">credential_type</span><span class="p">,</span> <span class="n">valid_types</span><span class="o">=</span><span class="n">_VALID_TYPES</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_get_gcloud_sdk_credentials</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Gets the credentials and project ID from the Cloud SDK.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">google.auth</span> <span class="kn">import</span> <span class="n">_cloud_sdk</span>

    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking Cloud SDK credentials as part of auth process...&quot;</span><span class="p">)</span>

    <span class="c1"># Check if application default credentials exist.</span>
    <span class="n">credentials_filename</span> <span class="o">=</span> <span class="n">_cloud_sdk</span><span class="o">.</span><span class="n">get_application_default_credentials_path</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">credentials_filename</span><span class="p">):</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cloud SDK credentials not found on disk; not using them&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">credentials</span><span class="p">,</span> <span class="n">project_id</span> <span class="o">=</span> <span class="n">load_credentials_from_file</span><span class="p">(</span><span class="n">credentials_filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">project_id</span><span class="p">:</span>
        <span class="n">project_id</span> <span class="o">=</span> <span class="n">_cloud_sdk</span><span class="o">.</span><span class="n">get_project_id</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">project_id</span>


<span class="k">def</span> <span class="nf">_get_explicit_environ_credentials</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Gets credentials from the GOOGLE_APPLICATION_CREDENTIALS environment</span>
<span class="sd">    variable.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">google.auth</span> <span class="kn">import</span> <span class="n">_cloud_sdk</span>

    <span class="n">cloud_sdk_adc_path</span> <span class="o">=</span> <span class="n">_cloud_sdk</span><span class="o">.</span><span class="n">get_application_default_credentials_path</span><span class="p">()</span>
    <span class="n">explicit_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">environment_vars</span><span class="o">.</span><span class="n">CREDENTIALS</span><span class="p">)</span>

    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Checking </span><span class="si">%s</span><span class="s2"> for explicit credentials as part of auth process...&quot;</span><span class="p">,</span> <span class="n">explicit_file</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">explicit_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">explicit_file</span> <span class="o">==</span> <span class="n">cloud_sdk_adc_path</span><span class="p">:</span>
        <span class="c1"># Cloud sdk flow calls gcloud to fetch project id, so if the explicit</span>
        <span class="c1"># file path is cloud sdk credentials path, then we should fall back</span>
        <span class="c1"># to cloud sdk flow, otherwise project id cannot be obtained.</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Explicit credentials path </span><span class="si">%s</span><span class="s2"> is the same as Cloud SDK credentials path, fall back to Cloud SDK credentials flow...&quot;</span><span class="p">,</span>
            <span class="n">explicit_file</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_get_gcloud_sdk_credentials</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">explicit_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">credentials</span><span class="p">,</span> <span class="n">project_id</span> <span class="o">=</span> <span class="n">load_credentials_from_file</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">environment_vars</span><span class="o">.</span><span class="n">CREDENTIALS</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">project_id</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_get_gae_credentials</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Gets Google App Engine App Identity credentials and project ID.&quot;&quot;&quot;</span>
    <span class="c1"># While this library is normally bundled with app_engine, there are</span>
    <span class="c1"># some cases where it&#39;s not available, so we tolerate ImportError.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking for App Engine runtime as part of auth process...&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">google.auth.app_engine</span> <span class="k">as</span> <span class="nn">app_engine</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Import of App Engine auth library failed.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">credentials</span> <span class="o">=</span> <span class="n">app_engine</span><span class="o">.</span><span class="n">Credentials</span><span class="p">()</span>
        <span class="n">project_id</span> <span class="o">=</span> <span class="n">app_engine</span><span class="o">.</span><span class="n">get_project_id</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">project_id</span>
    <span class="k">except</span> <span class="ne">EnvironmentError</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;No App Engine library was found so cannot authentication via App Engine Identity Credentials.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_get_gce_credentials</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets credentials and project ID from the GCE Metadata Service.&quot;&quot;&quot;</span>
    <span class="c1"># Ping requires a transport, but we want application default credentials</span>
    <span class="c1"># to require no arguments. So, we&#39;ll use the _http_client transport which</span>
    <span class="c1"># uses http.client. This is only acceptable because the metadata server</span>
    <span class="c1"># doesn&#39;t do SSL and never requires proxies.</span>

    <span class="c1"># While this library is normally bundled with compute_engine, there are</span>
    <span class="c1"># some cases where it&#39;s not available, so we tolerate ImportError.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">google.auth</span> <span class="kn">import</span> <span class="n">compute_engine</span>
        <span class="kn">from</span> <span class="nn">google.auth.compute_engine</span> <span class="kn">import</span> <span class="n">_metadata</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Import of Compute Engine auth library failed.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">google</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">_http_client</span><span class="o">.</span><span class="n">Request</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">_metadata</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">):</span>
        <span class="c1"># Get the project ID.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">project_id</span> <span class="o">=</span> <span class="n">_metadata</span><span class="o">.</span><span class="n">get_project_id</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">TransportError</span><span class="p">:</span>
            <span class="n">project_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">compute_engine</span><span class="o">.</span><span class="n">Credentials</span><span class="p">(),</span> <span class="n">project_id</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Authentication failed using Compute Engine authentication due to unavailable metadata server.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_get_external_account_credentials</span><span class="p">(</span>
    <span class="n">info</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_scopes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads external account Credentials from the parsed external account info.</span>

<span class="sd">    The credentials information must correspond to a supported external account</span>
<span class="sd">    credentials.</span>

<span class="sd">    Args:</span>
<span class="sd">        info (Mapping[str, str]): The external account info in Google format.</span>
<span class="sd">        filename (str): The full path to the credentials file.</span>
<span class="sd">        scopes (Optional[Sequence[str]]): The list of scopes for the credentials. If</span>
<span class="sd">            specified, the credentials will automatically be scoped if</span>
<span class="sd">            necessary.</span>
<span class="sd">        default_scopes (Optional[Sequence[str]]): Default scopes passed by a</span>
<span class="sd">            Google client library. Use &#39;scopes&#39; for user-defined scopes.</span>
<span class="sd">        request (Optional[google.auth.transport.Request]): An object used to make</span>
<span class="sd">            HTTP requests. This is used to determine the associated project ID</span>
<span class="sd">            for a workload identity pool resource (external account credentials).</span>
<span class="sd">            If not specified, then it will use a</span>
<span class="sd">            google.auth.transport.requests.Request client to make requests.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[google.auth.credentials.Credentials, Optional[str]]: Loaded</span>
<span class="sd">            credentials and the project ID. External account credentials project</span>
<span class="sd">            IDs may not always be determined.</span>

<span class="sd">    Raises:</span>
<span class="sd">        google.auth.exceptions.DefaultCredentialsError: if the info dictionary</span>
<span class="sd">            is in the wrong format or is missing required information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># There are currently 2 types of external_account credentials.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if configuration corresponds to an AWS credentials.</span>
        <span class="kn">from</span> <span class="nn">google.auth</span> <span class="kn">import</span> <span class="n">aws</span>

        <span class="n">credentials</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">Credentials</span><span class="o">.</span><span class="n">from_info</span><span class="p">(</span>
            <span class="n">info</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="n">scopes</span><span class="p">,</span> <span class="n">default_scopes</span><span class="o">=</span><span class="n">default_scopes</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Check if configuration corresponds to an Identity Pool credentials.</span>
            <span class="kn">from</span> <span class="nn">google.auth</span> <span class="kn">import</span> <span class="n">identity_pool</span>

            <span class="n">credentials</span> <span class="o">=</span> <span class="n">identity_pool</span><span class="o">.</span><span class="n">Credentials</span><span class="o">.</span><span class="n">from_info</span><span class="p">(</span>
                <span class="n">info</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="n">scopes</span><span class="p">,</span> <span class="n">default_scopes</span><span class="o">=</span><span class="n">default_scopes</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># If the configuration is invalid or does not correspond to any</span>
            <span class="c1"># supported external_account credentials, raise an error.</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DefaultCredentialsError</span><span class="p">(</span>
                <span class="s2">&quot;Failed to load external account credentials from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">google</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">Request</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">credentials</span><span class="o">.</span><span class="n">get_project_id</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>


<div class="viewcode-block" id="default"><a class="viewcode-back" href="../../../reference/google.auth.html#google.auth.default">[docs]</a><span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quota_project_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_scopes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the default credentials for the current environment.</span>

<span class="sd">    `Application Default Credentials`_ provides an easy way to obtain</span>
<span class="sd">    credentials to call Google APIs for server-to-server or local applications.</span>
<span class="sd">    This function acquires credentials from the environment in the following</span>
<span class="sd">    order:</span>

<span class="sd">    1. If the environment variable ``GOOGLE_APPLICATION_CREDENTIALS`` is set</span>
<span class="sd">       to the path of a valid service account JSON private key file, then it is</span>
<span class="sd">       loaded and returned. The project ID returned is the project ID defined</span>
<span class="sd">       in the service account file if available (some older files do not</span>
<span class="sd">       contain project ID information).</span>

<span class="sd">       If the environment variable is set to the path of a valid external</span>
<span class="sd">       account JSON configuration file (workload identity federation), then the</span>
<span class="sd">       configuration file is used to determine and retrieve the external</span>
<span class="sd">       credentials from the current environment (AWS, Azure, etc).</span>
<span class="sd">       These will then be exchanged for Google access tokens via the Google STS</span>
<span class="sd">       endpoint.</span>
<span class="sd">       The project ID returned in this case is the one corresponding to the</span>
<span class="sd">       underlying workload identity pool resource if determinable.</span>
<span class="sd">    2. If the `Google Cloud SDK`_ is installed and has application default</span>
<span class="sd">       credentials set they are loaded and returned.</span>

<span class="sd">       To enable application default credentials with the Cloud SDK run::</span>

<span class="sd">            gcloud auth application-default login</span>

<span class="sd">       If the Cloud SDK has an active project, the project ID is returned. The</span>
<span class="sd">       active project can be set using::</span>

<span class="sd">            gcloud config set project</span>

<span class="sd">    3. If the application is running in the `App Engine standard environment`_</span>
<span class="sd">       (first generation) then the credentials and project ID from the</span>
<span class="sd">       `App Identity Service`_ are used.</span>
<span class="sd">    4. If the application is running in `Compute Engine`_ or `Cloud Run`_ or</span>
<span class="sd">       the `App Engine flexible environment`_ or the `App Engine standard</span>
<span class="sd">       environment`_ (second generation) then the credentials and project ID</span>
<span class="sd">       are obtained from the `Metadata Service`_.</span>
<span class="sd">    5. If no credentials are found,</span>
<span class="sd">       :class:`~google.auth.exceptions.DefaultCredentialsError` will be raised.</span>

<span class="sd">    .. _Application Default Credentials: https://developers.google.com\</span>
<span class="sd">            /identity/protocols/application-default-credentials</span>
<span class="sd">    .. _Google Cloud SDK: https://cloud.google.com/sdk</span>
<span class="sd">    .. _App Engine standard environment: https://cloud.google.com/appengine</span>
<span class="sd">    .. _App Identity Service: https://cloud.google.com/appengine/docs/python\</span>
<span class="sd">            /appidentity/</span>
<span class="sd">    .. _Compute Engine: https://cloud.google.com/compute</span>
<span class="sd">    .. _App Engine flexible environment: https://cloud.google.com\</span>
<span class="sd">            /appengine/flexible</span>
<span class="sd">    .. _Metadata Service: https://cloud.google.com/compute/docs\</span>
<span class="sd">            /storing-retrieving-metadata</span>
<span class="sd">    .. _Cloud Run: https://cloud.google.com/run</span>

<span class="sd">    Example::</span>

<span class="sd">        import google.auth</span>

<span class="sd">        credentials, project_id = google.auth.default()</span>

<span class="sd">    Args:</span>
<span class="sd">        scopes (Sequence[str]): The list of scopes for the credentials. If</span>
<span class="sd">            specified, the credentials will automatically be scoped if</span>
<span class="sd">            necessary.</span>
<span class="sd">        request (Optional[google.auth.transport.Request]): An object used to make</span>
<span class="sd">            HTTP requests. This is used to either detect whether the application</span>
<span class="sd">            is running on Compute Engine or to determine the associated project</span>
<span class="sd">            ID for a workload identity pool resource (external account</span>
<span class="sd">            credentials). If not specified, then it will either use the standard</span>
<span class="sd">            library http client to make requests for Compute Engine credentials</span>
<span class="sd">            or a google.auth.transport.requests.Request client for external</span>
<span class="sd">            account credentials.</span>
<span class="sd">        quota_project_id (Optional[str]): The project ID used for</span>
<span class="sd">            quota and billing.</span>
<span class="sd">        default_scopes (Optional[Sequence[str]]): Default scopes passed by a</span>
<span class="sd">            Google client library. Use &#39;scopes&#39; for user-defined scopes.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple[~google.auth.credentials.Credentials, Optional[str]]:</span>
<span class="sd">            the current environment&#39;s credentials and project ID. Project ID</span>
<span class="sd">            may be None, which indicates that the Project ID could not be</span>
<span class="sd">            ascertained from the environment.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ~google.auth.exceptions.DefaultCredentialsError:</span>
<span class="sd">            If no credentials were found, or if the credentials found were</span>
<span class="sd">            invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">google.auth.credentials</span> <span class="kn">import</span> <span class="n">with_scopes_if_required</span>

    <span class="n">explicit_project_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">environment_vars</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">environment_vars</span><span class="o">.</span><span class="n">LEGACY_PROJECT</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">checkers</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># Avoid passing scopes here to prevent passing scopes to user credentials.</span>
        <span class="c1"># with_scopes_if_required() below will ensure scopes/default scopes are</span>
        <span class="c1"># safely set on the returned credentials since requires_scopes will</span>
        <span class="c1"># guard against setting scopes on user credentials.</span>
        <span class="n">_get_explicit_environ_credentials</span><span class="p">,</span>
        <span class="n">_get_gcloud_sdk_credentials</span><span class="p">,</span>
        <span class="n">_get_gae_credentials</span><span class="p">,</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">_get_gce_credentials</span><span class="p">(</span><span class="n">request</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">checker</span> <span class="ow">in</span> <span class="n">checkers</span><span class="p">:</span>
        <span class="n">credentials</span><span class="p">,</span> <span class="n">project_id</span> <span class="o">=</span> <span class="n">checker</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">credentials</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">credentials</span> <span class="o">=</span> <span class="n">with_scopes_if_required</span><span class="p">(</span>
                <span class="n">credentials</span><span class="p">,</span> <span class="n">scopes</span><span class="p">,</span> <span class="n">default_scopes</span><span class="o">=</span><span class="n">default_scopes</span>
            <span class="p">)</span>

            <span class="c1"># For external account credentials, scopes are required to determine</span>
            <span class="c1"># the project ID. Try to get the project ID again if not yet</span>
            <span class="c1"># determined.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">project_id</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">credentials</span><span class="p">,</span> <span class="s2">&quot;get_project_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="n">google</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">Request</span><span class="p">()</span>
                <span class="n">project_id</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">get_project_id</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">quota_project_id</span><span class="p">:</span>
                <span class="n">credentials</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">with_quota_project</span><span class="p">(</span><span class="n">quota_project_id</span><span class="p">)</span>

            <span class="n">effective_project_id</span> <span class="o">=</span> <span class="n">explicit_project_id</span> <span class="ow">or</span> <span class="n">project_id</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">effective_project_id</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;No project ID could be determined. Consider running &quot;</span>
                    <span class="s2">&quot;`gcloud config set project` or setting the </span><span class="si">%s</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;environment variable&quot;</span><span class="p">,</span>
                    <span class="n">environment_vars</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">effective_project_id</span>

    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DefaultCredentialsError</span><span class="p">(</span><span class="n">_HELP_MESSAGE</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">google-auth</a></h1>



<p class="blurb">Google Auth Library for Python</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=GoogleCloudPlatform&repo=google-auth-library-python&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/GoogleCloudPlatform/google-auth-library-python">
    <img
        alt="https://secure.travis-ci.org/GoogleCloudPlatform/google-auth-library-python.svg?branch=master"
        src="https://secure.travis-ci.org/GoogleCloudPlatform/google-auth-library-python.svg?branch=master"
    />
</a>
</p>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user-guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/modules.html">Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Google, Inc..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/GoogleCloudPlatform/google-auth-library-python" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>